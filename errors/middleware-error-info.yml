title: "middleware の 'Cannot read properties of undefined (reading \"custom\")' エラー説明"
date: "2026-02-06"
error_message: "TypeError: Cannot read properties of undefined (reading 'custom')"
stack_trace_excerpt: |
  ./node_modules/openid-client/lib/device_flow_handle.js
  file:.next/server/middleware.js (2004:1)
  ./node_modules/openid-client/lib/client.js
  ./node_modules/openid-client/lib/issuer.js

summary: |
  middleware 実行時に Next.js のビルド済み middleware バンドル内で
  openid-client が例外を投げている。結果として middleware が正しく
  初期化できず、アプリケーションの起動やルーティングに影響が出る。

probable_causes:
  - 認証プロバイダ（OAuth / OIDC）の設定が未設定または不正で、
    NextAuth が期待するプロバイダメタデータが生成されない
  - NextAuth の初期化時に adapter/プロバイダ設定の不整合があり、
    openid-client を呼び出すコードが不正な引数を受け取っている
  - 開発環境でダミー値（空またはプレースホルダ）を渡したため、
    内部で想定しないオブジェクトが undefined になっている

confirmed_findings: |
  - エラースタックに openid-client が含まれていることから、
    OAuth/OIDC 系の処理が関与している
  - プロジェクト内では Email プロバイダのみを使用しているが、
    環境変数や他の設定（例: Google OAuth のプレースホルダ）が存在し、
    NextAuth 初期化時に副作用が出る可能性がある

temporary_workarounds:
  - middleware を無効化してアプリを起動する（ファイル名を変更する等）
  - Email の送信処理を開発モードで無効化（sendVerificationRequest をログ出力に差し替える）

permanent_fix_steps:
  - 1) まず `app/auth.ts` を確認し、使用するプロバイダのみを明示的に定義する
    - 余分な OAuth プロバイダ設定（未使用の Google 設定など）があれば削除またはコメントアウト
  - 2) NextAuth に `adapter` を正しく設定する（Prisma を使う場合は `PrismaAdapter(prisma)`）
  - 3) 必須の環境変数を `.env.local` に設定する
    - `NEXTAUTH_URL`, `NEXTAUTH_SECRET`, `DATABASE_URL`
    - Email を使う場合は `EMAIL_SERVER_HOST`, `EMAIL_SERVER_PORT`, `EMAIL_SERVER_USER`, `EMAIL_SERVER_PASSWORD`, `EMAIL_FROM`
  - 4) `session.strategy` を使用状況に合わせて設定する（PrismaAdapter 使用時は `database`）
  - 5) 依存関係とキャッシュをクリアして再ビルドする
    - `rm -rf node_modules .next`
    - `npm install`
    - `npm run dev`
  - 6) middleware を有効に戻して（`middleware.ts.disabled` → `middleware.ts`）、再度確認する

files_to_check:
  - app/auth.ts
  - middleware.ts
  - .env.local
  - prisma/schema.prisma
  - package.json

how_to_reproduce:
  - middleware を有効化した状態で `npm run dev` を実行する
  - 未設定／プレースホルダの OAuth 環境変数があるとビルド時に openid-client 呼び出しで例外が発生することを確認

notes:
  - openid-client は OIDC/OAuth 用の低レベルライブラリで、NextAuth の OAuth プロバイダ使用時に内部で読み込まれる
  - Email のみを使う構成で openid-client が読み込まれる場合は、プロジェクト内の設定や依存関係（別のプロバイダ定義）を再確認する

references:
  - next-auth docs: https://next-auth.js.org/
  - openid-client: https://github.com/panva/node-openid-client

last_actions_taken:
  - PrismaAdapter を `app/auth.ts` に追加
  - `session.strategy` を `database` に変更
  - Email の sendVerificationRequest を開発ログ出力に差し替え
  - `.next` キャッシュを削除
  - `middleware.ts` を一時的に無効化（`middleware.ts.disabled`）

recommended_next_steps:
  - 本番運用する前に、実際のメールサーバー情報または使用する OAuth プロバイダの正しい値を設定する
  - middleware を有効化して問題が再発しないことを確認する

contact: "対応中の開発者または運用担当者に連絡してください"
